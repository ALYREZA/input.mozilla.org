{% extends "base.html" %}

{% macro fieldbox(name, show_errors=True): %}
  {% with field = form[name] %}
    <div class="fieldWrapper wrap_{{ field.name }}">
      {{ field.label_tag()|safe }} {{ field|safe }}
      {% if show_errors %}{{ field.errors|safe }}{% endif %}
    </div>
  {% endwith %}
{% endmacro %}

{% macro button(name, value='', label='', classes='') -%}
  {% if form.cleaned_data[name] == value %}
  <a class="button active {{ classes }}"
  {% else %}
  <a class="button {{ classes }}"
  {% endif %}
     href="{{ search_url( **{name: value} ) }}"> {{ label }}
  </a>
{%- endmacro %}

{% block page_title %}{{ _('Input Dashboard - Sites') }}{% endblock %}
{% block body_id %}website_issues{% endblock %}

{% block content %}
<h2>{{ _('Input Dashboard â€“ Sites') }}</h2>
<div id="top_menu">
{{ button('show_one_offs', False, 
          _('Show sites with clusters'), 'left') }}
{{ button('show_one_offs', True, 
          _('Show sites with only one message'), 'right') }}
</div>
<div class="container" id="results">
  {% if sites|length == 0 %}
  <div id="none-found">
    {{ _('Oh, no results!') }}<p>
    <a href="{{ url('website_issues') }}">{{ _('reset my search') }}</a>
  </div>
  {% endif %}
  <ul id="cluster-sites">
  {% for site in sites %}
    <li>
      <h3><a title="visit this site" 
             id="site-{{ site.id }}" href="{{ site.url }}">
          <span class="protocol">{{ protocol(site.url) }} </span>{{
            without_protocol(site.url) }}</a></h3>
      <h3 class="site_count">({{_('{0} comments')|f(site.size) }})</h3>
      <ul class="clusters">
      {% for cluster in site.clusters %}
        {% if loop.index0 == 3 and site.id != expanded_site_id %}
        <li class="more">
          <a href="{{ search_url('site-%i' % site.id, site=site.id) }}"
          >{{_('more')}}</a>
        </li>
        {% endif %}

        {% if loop.index0 >= 3 and site.id != expanded_site_id %}
        <li class="less extra" id="cluster-{{cluster.id}}">
        {% else %}
        <li id="cluster-{{ cluster.id }}">
        {% endif %}
          <h4>
            <em>{{ cluster.primary|replace('"','') }}</em>
            {% if cluster.cluster_size > 1 %}
            <a href="{{ search_url('site-%i' %site.id, cluster='' ) }}"
               title="{{_('Hide similar comments')}}" 
               class="{% if cluster.id != expanded_cluster_id %}less {% endif 
                      %}hide_similar">
               ({{_('hide similar')}})
            </a>             
            <a href="{{ search_url('site-%i' %site.id, cluster=cluster.id) }}"
                  title="{{_('Similar comments')}}" 
                  class="{% if cluster.id == expanded_cluster_id %}less {% 
                         endif %}show_similar">
               ({{ _('{0} similar')|f(cluster.cluster_size) }})
            </a> 
            {% endif %}
          </h4>
          
          <ol class="{% if cluster.id != expanded_cluster_id
                     %}less {% endif %}cluster_comments">
             {% for c in expanded_comments %}
             <li>{{ c|replace('"','') }}</li>
             {% endfor %}
          </ol>
        </li>
      {% endfor %}    
        <div class="quick_sentiments">
          <a title="Show positive comments"
             href="{{ search_url( 'site-%i' % site.id, 
                                    sentiment='happy' ) }}">
             {{ _('{0} positive')|f(site.sentiments[1]) }}</a>
          | 
          <a title="Show negative comments"
             href="{{ search_url( 'site-%i' % site.id, sentiment='sad' ) }}">
             {{ _('{0} negative')|f(site.sentiments[0]) }}</a>
        </div>
      </ul>
    </li>
  {% endfor %}
  </ul>
  
  {% if page and page.has_other_pages() %}
    <nav class="pagination">
      <span class="step-links">
        {% if page.has_previous() %}
        <a href="{{ search_url(page=page.previous_page_number()) }}"
           class="prev">{{ _('&laquo; previous')|safe }}</a>
        {% endif %}

        {% if page.has_next() %}
        <a href="{{ search_url(page=page.next_page_number()) }}"
           class="next">{{ _('next &raquo;')|safe }}</a>
        {% endif %}

        <span class="current">
          {% trans pagenum=page.number, total=page.paginator.num_pages %}
            page {{ pagenum }} of {{ total }}
          {% endtrans %}
        </span>
      </span>
    </nav>
  {% endif %}
  
</div>

<div id="search_form">
  <form method="get" action="{{ url('website_issues') }}">
    <div id="search-basic" class="clearfix">
      {{ fieldbox('q') }}
      {# make hidden input fields for settings to keep on text-search #}
      {{ fieldbox('sentiment') }}
      {{ fieldbox('search_type') }}
      {{ fieldbox('show_one_offs') }}
      <div>
      {{ button('sentiment', 'happy', _('Happy'), 'left') }}{{
        button('sentiment', '', _('Both') ) }}{{ 
        button('sentiment', 'sad', _('Sad'), 'right') }}
      </div>
      <div>
      {{ button('search_type', 'latest beta', _('Latest Beta'), 'left') }}
      {{ button('search_type', 'week', _('7 Days'), 'right') }}
      </div>
    </div>
</div>
{% endblock %}


{% block js %}
<script type="text/javascript">
$(".more a").click( function( e ) {
    e.preventDefault();
    var li = e.target.parentNode;
    $(".extra", li.parentNode ).fadeIn();
    $( li ).toggleClass( "less" );
    return false;
} );

var cluster_id_matcher = /\bcluster-(\d+)\b/;
{% if expanded_cluster_id %}
var open_cluster = document.getElementById("cluster-{{expanded_cluster_id}}");
{% else %}
var open_cluster = null;
{% endif %}
$(".show_similar, .hide_similar").click( function( e ) {
    var h4 = e.target.parentNode;
    var cluster = h4.parentNode;
    if (open_cluster) {
        $( "ol", open_cluster ).slideUp();
        $( ".hide_similar", open_cluster ).hide();
        $( ".show_similar", open_cluster ).show();
    }
    if (cluster == open_cluster) return false;

    open_cluster = cluster;    
    var cluster_id = cluster.id.substring("cluster-".length);
    var url = "{{ url('website_issues_cluster', 0) }}";
    url = url.replace(/0$/, cluster_id);
    $( ".hide_similar", cluster).show();
    $( ".show_similar", cluster).hide();
    $( "ol", cluster ).addClass("ajax_loading").slideDown().load(
      url, function() { $( "ol", cluster ).removeClass( "ajax_loading" ); } 
    );
    return false;
} );
</script>
{% endblock %}

